<!DOCTYPE html>
<html lang="en">
<head>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<h1>Music</h1>
<!-- https://codepen.io/craigstroman/pen/aOyRYx -->
<h2>Currently in room: <span id="roomID"></span></h2>
<label for="room">Room</label><input id="room" />
<button onclick="roomChange()">Join Room</button>

<audio id="audioPlayer" preload="none" tabindex="0" controls>
    <source src="music.mp3" data-track-number="1" />
    <source src="https://archive.org/download/calexico2006-12-02..flac16/calexico2006-12-02d1t02.mp3" data-track-number="2" />
</audio>

<button onclick="changeSong()">Next song</button>

<span id="currentTime">0</span>

<button id="takeControl">Take Control</button> | <button id="giveControl">Give up control</button>

<script>
    // Stage 1, collect room location
    function roomChange() {
    	let roomID = document.getElementById('room');
    	console.log("Room changed", roomID.value);
        socket.emit('room:change', roomID.value);
        localStorage.setItem('room', roomID.value); // todo: security
    }
    function changeSong() {
    	console.log(">>changeSong() -- client changing song");
        socket.emit('song:change', {
        	'room': localStorage.getItem('room'),
        	'song': 'https://archive.org/download/calexico2006-12-02..flac16/calexico2006-12-02d1t02.mp3'
		});
    }
	let audioPlayer = document.getElementById('audioPlayer');
	let currentTimeText = document.getElementById('currentTime');
	let songData = {
        currentTime: 0
	};

	// Received: Socket connection events
	let socket = io();

	socket.on('broadcasted:song:change', function(msg) {
        console.log("Song change notification", msg);
		audioPlayer.setAttribute('src', 'https://archive.org/download/calexico2006-12-02..flac16/calexico2006-12-02d1t02.mp3');
		audioPlayer.play();
	});

    audioPlayer.onplay = () => {
	    console.log("play");
		audioPlayer.currentTime = 0;
    };

	// Send time updates to listeners
	audioPlayer.ontimeupdate = () => {
		currentTimeText.innerText = audioPlayer.currentTime;
		songData.currentTime = audioPlayer.currentTime;
		socket.send(JSON.stringify(songData));
    };

</script>
</body>
</html>